{"ast":null,"code":"// src/services/chatServices.js\n// THIS FILE MUST HAVE THE PATHS CHANGED TO THE BACKEND SERVER\n\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added backend call to retrieve stakeholder ID\r\n   Description: Fetches the stakeholderid for a given email from the backend\r\n*/\nconst API_BACKEND = process.env.REACT_APP_API_BACKEND;\nexport const getStakeholderId = async email => {\n  const res = await fetch(`${API_BACKEND}/supabase/getStakeholderId`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      email\n    })\n  });\n  if (!res.ok) {\n    const text = await res.text();\n    throw new Error(`Backend error: ${res.status} ${text}`);\n  }\n  return res.json();\n};\n\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added user chat fetching\r\n   Description: Retrieves all chats for a user since an optional timestamp\r\n*/\nexport async function getUserChats(email, since = null) {\n  const res = await fetch(`${API_BACKEND}/supabase/getUserChats`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\"\n    },\n    body: JSON.stringify({\n      email,\n      since\n    })\n  });\n  if (!res.ok) throw new Error(\"Failed to fetch user chats\");\n  return res.json();\n}\n\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added chat update function\r\n   Description: Sends a new chat message (ciphertext + iv) to the backend\r\n*/\nexport async function updateChatHistory(donationid, senderid, chathistory, iv = null, message_timestamp = null) {\n  const requestBody = {\n    donationid,\n    senderid,\n    chathistory,\n    iv,\n    message_timestamp: message_timestamp || new Date().toISOString() // fallback\n  };\n  console.log('Sending to backend:', requestBody);\n  const res = await fetch(`${API_BACKEND}/supabase/updateChatHistory`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\"\n    },\n    body: JSON.stringify(requestBody)\n  });\n  if (!res.ok) {\n    const text = await res.text();\n    console.error('Backend error details:', text);\n    throw new Error(`Failed to update chat history: ${res.status} ${text}`);\n  }\n  return res.json();\n}\n\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added read receipt marking\r\n   Description: Marks all messages as read for a donation, excluding the current user\r\n*/\nexport async function markChatRead(donationid, currentUserId) {\n  const res = await fetch(`${API_BACKEND}/supabase/markChatRead`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\"\n    },\n    body: JSON.stringify({\n      donationid,\n      currentUserId\n    })\n  });\n  if (!res.ok) throw new Error(\"Failed to mark chat read\");\n  return res.json();\n}\n\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added delivery receipt marking\r\n   Description: Marks all messages as delivered for a donation, excluding the sender\r\n*/\nexport async function markDelivered(donationid, userId) {\n  const res = await fetch(`${API_BACKEND}/supabase/markDelivered`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\"\n    },\n    body: JSON.stringify({\n      donationid,\n      userId\n    })\n  });\n  if (!res.ok) throw new Error(\"Failed to mark delivered\");\n  return res.json();\n}","map":{"version":3,"names":["API_BACKEND","process","env","REACT_APP_API_BACKEND","getStakeholderId","email","res","fetch","method","headers","body","JSON","stringify","ok","text","Error","status","json","getUserChats","since","updateChatHistory","donationid","senderid","chathistory","iv","message_timestamp","requestBody","Date","toISOString","console","log","error","markChatRead","currentUserId","markDelivered","userId"],"sources":["C:/Users/letha/Downloads/EPE Sem Project - the Reclone/foodsave-hub/client/src/communication/services/chatServices.js"],"sourcesContent":["// src/services/chatServices.js\r\n// THIS FILE MUST HAVE THE PATHS CHANGED TO THE BACKEND SERVER\r\n\r\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added backend call to retrieve stakeholder ID\r\n   Description: Fetches the stakeholderid for a given email from the backend\r\n*/\r\nconst API_BACKEND = process.env.REACT_APP_API_BACKEND;\r\nexport const getStakeholderId = async (email) => {\r\n  const res = await fetch(`${API_BACKEND}/supabase/getStakeholderId`, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ email }),\r\n  });\r\n\r\n  if (!res.ok) {\r\n    const text = await res.text();\r\n    throw new Error(`Backend error: ${res.status} ${text}`);\r\n  }\r\n\r\n  return res.json();\r\n};\r\n\r\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added user chat fetching\r\n   Description: Retrieves all chats for a user since an optional timestamp\r\n*/\r\nexport async function getUserChats(email, since = null) {\r\n  const res = await fetch(`${API_BACKEND}/supabase/getUserChats`, {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify({ email, since }),\r\n  });\r\n\r\n  if (!res.ok) throw new Error(\"Failed to fetch user chats\");\r\n  return res.json();\r\n}\r\n\r\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added chat update function\r\n   Description: Sends a new chat message (ciphertext + iv) to the backend\r\n*/\r\nexport async function updateChatHistory(donationid, senderid, chathistory, iv = null, message_timestamp = null) {\r\n  const requestBody = { \r\n    donationid, \r\n    senderid, \r\n    chathistory, \r\n    iv,\r\n    message_timestamp: message_timestamp || new Date().toISOString() // fallback\r\n  };\r\n  \r\n  console.log('Sending to backend:', requestBody);\r\n  \r\n  const res = await fetch(`${API_BACKEND}/supabase/updateChatHistory`, {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(requestBody),\r\n  });\r\n\r\n  if (!res.ok) {\r\n    const text = await res.text();\r\n    console.error('Backend error details:', text);\r\n    throw new Error(`Failed to update chat history: ${res.status} ${text}`);\r\n  }\r\n\r\n  return res.json();\r\n}\r\n\r\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added read receipt marking\r\n   Description: Marks all messages as read for a donation, excluding the current user\r\n*/\r\nexport async function markChatRead(donationid, currentUserId) {\r\n  const res = await fetch(`${API_BACKEND}/supabase/markChatRead`, {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify({ donationid, currentUserId }),\r\n  });\r\n\r\n  if (!res.ok) throw new Error(\"Failed to mark chat read\");\r\n  return res.json();\r\n}\r\n\r\n/* Author: Lethabo Mazui\r\n   Event: Sprint 1\r\n   LatestUpdate: Added delivery receipt marking\r\n   Description: Marks all messages as delivered for a donation, excluding the sender\r\n*/\r\nexport async function markDelivered(donationid, userId) {\r\n  const res = await fetch(`${API_BACKEND}/supabase/markDelivered`, {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify({ donationid, userId }),\r\n  });\r\n\r\n  if (!res.ok) throw new Error(\"Failed to mark delivered\");\r\n  return res.json();\r\n}\r\n"],"mappings":"AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAMA,WAAW,GAAGC,OAAO,CAACC,GAAG,CAACC,qBAAqB;AACrD,OAAO,MAAMC,gBAAgB,GAAG,MAAOC,KAAK,IAAK;EAC/C,MAAMC,GAAG,GAAG,MAAMC,KAAK,CAAC,GAAGP,WAAW,4BAA4B,EAAE;IAClEQ,MAAM,EAAE,MAAM;IACdC,OAAO,EAAE;MAAE,cAAc,EAAE;IAAmB,CAAC;IAC/CC,IAAI,EAAEC,IAAI,CAACC,SAAS,CAAC;MAAEP;IAAM,CAAC;EAChC,CAAC,CAAC;EAEF,IAAI,CAACC,GAAG,CAACO,EAAE,EAAE;IACX,MAAMC,IAAI,GAAG,MAAMR,GAAG,CAACQ,IAAI,CAAC,CAAC;IAC7B,MAAM,IAAIC,KAAK,CAAC,kBAAkBT,GAAG,CAACU,MAAM,IAAIF,IAAI,EAAE,CAAC;EACzD;EAEA,OAAOR,GAAG,CAACW,IAAI,CAAC,CAAC;AACnB,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA,OAAO,eAAeC,YAAYA,CAACb,KAAK,EAAEc,KAAK,GAAG,IAAI,EAAE;EACtD,MAAMb,GAAG,GAAG,MAAMC,KAAK,CAAC,GAAGP,WAAW,wBAAwB,EAAE;IAC9DQ,MAAM,EAAE,MAAM;IACdC,OAAO,EAAE;MAAE,cAAc,EAAE;IAAmB,CAAC;IAC/CC,IAAI,EAAEC,IAAI,CAACC,SAAS,CAAC;MAAEP,KAAK;MAAEc;IAAM,CAAC;EACvC,CAAC,CAAC;EAEF,IAAI,CAACb,GAAG,CAACO,EAAE,EAAE,MAAM,IAAIE,KAAK,CAAC,4BAA4B,CAAC;EAC1D,OAAOT,GAAG,CAACW,IAAI,CAAC,CAAC;AACnB;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO,eAAeG,iBAAiBA,CAACC,UAAU,EAAEC,QAAQ,EAAEC,WAAW,EAAEC,EAAE,GAAG,IAAI,EAAEC,iBAAiB,GAAG,IAAI,EAAE;EAC9G,MAAMC,WAAW,GAAG;IAClBL,UAAU;IACVC,QAAQ;IACRC,WAAW;IACXC,EAAE;IACFC,iBAAiB,EAAEA,iBAAiB,IAAI,IAAIE,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC,CAAC;EACnE,CAAC;EAEDC,OAAO,CAACC,GAAG,CAAC,qBAAqB,EAAEJ,WAAW,CAAC;EAE/C,MAAMpB,GAAG,GAAG,MAAMC,KAAK,CAAC,GAAGP,WAAW,6BAA6B,EAAE;IACnEQ,MAAM,EAAE,MAAM;IACdC,OAAO,EAAE;MAAE,cAAc,EAAE;IAAmB,CAAC;IAC/CC,IAAI,EAAEC,IAAI,CAACC,SAAS,CAACc,WAAW;EAClC,CAAC,CAAC;EAEF,IAAI,CAACpB,GAAG,CAACO,EAAE,EAAE;IACX,MAAMC,IAAI,GAAG,MAAMR,GAAG,CAACQ,IAAI,CAAC,CAAC;IAC7Be,OAAO,CAACE,KAAK,CAAC,wBAAwB,EAAEjB,IAAI,CAAC;IAC7C,MAAM,IAAIC,KAAK,CAAC,kCAAkCT,GAAG,CAACU,MAAM,IAAIF,IAAI,EAAE,CAAC;EACzE;EAEA,OAAOR,GAAG,CAACW,IAAI,CAAC,CAAC;AACnB;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO,eAAee,YAAYA,CAACX,UAAU,EAAEY,aAAa,EAAE;EAC5D,MAAM3B,GAAG,GAAG,MAAMC,KAAK,CAAC,GAAGP,WAAW,wBAAwB,EAAE;IAC9DQ,MAAM,EAAE,MAAM;IACdC,OAAO,EAAE;MAAE,cAAc,EAAE;IAAmB,CAAC;IAC/CC,IAAI,EAAEC,IAAI,CAACC,SAAS,CAAC;MAAES,UAAU;MAAEY;IAAc,CAAC;EACpD,CAAC,CAAC;EAEF,IAAI,CAAC3B,GAAG,CAACO,EAAE,EAAE,MAAM,IAAIE,KAAK,CAAC,0BAA0B,CAAC;EACxD,OAAOT,GAAG,CAACW,IAAI,CAAC,CAAC;AACnB;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO,eAAeiB,aAAaA,CAACb,UAAU,EAAEc,MAAM,EAAE;EACtD,MAAM7B,GAAG,GAAG,MAAMC,KAAK,CAAC,GAAGP,WAAW,yBAAyB,EAAE;IAC/DQ,MAAM,EAAE,MAAM;IACdC,OAAO,EAAE;MAAE,cAAc,EAAE;IAAmB,CAAC;IAC/CC,IAAI,EAAEC,IAAI,CAACC,SAAS,CAAC;MAAES,UAAU;MAAEc;IAAO,CAAC;EAC7C,CAAC,CAAC;EAEF,IAAI,CAAC7B,GAAG,CAACO,EAAE,EAAE,MAAM,IAAIE,KAAK,CAAC,0BAA0B,CAAC;EACxD,OAAOT,GAAG,CAACW,IAAI,CAAC,CAAC;AACnB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}